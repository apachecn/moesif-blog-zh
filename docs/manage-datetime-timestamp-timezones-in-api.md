# 基于成千上万的 API，在 API 和应用中处理时区、时间戳和日期时间的最佳方法和格式是什么

> 原文：<https://www.moesif.com/blog/technical/timestamp/manage-datetime-timestamp-timezones-in-api/>

## 背景

假设您有一个应用程序(移动或网络)，通常您希望显示终端用户的当地时间。但是，您的数据库仍然需要存储时间。虽然这是一个常见的场景，但经常会出现几个问题:

*   您应该如何在数据库中存储用户的时区？
*   你什么时候把它转换成当地时间？
*   假设您在客户端和后端之间有一个 API，时间戳应该如何表示？
*   日期时间将以什么格式存储在数据库中？

## 数据库如何存储日期时间

数据库被设计成高效地存储日期，最小化空间，同时尽可能快地进行查询。因为整数比字符串更容易查询、索引，并且空间效率更高，所以日期通常存储为 64 位整数，例如以毫秒为单位的 unix 纪元。作为数据库的用户，您通常不需要关于实现细节的详细信息，因此可以利用数据库提供的`date`或`datetime`数据类型。应该没有理由将日期存储为原始字符串或 bigint。

数据库会将任何`datetime`转换成 UTC 纪元以存储在内部。但是，一些数据库可能支持存储时区信息。如果是这种情况，建议在存储之前将所有日期转换为 UTC。

不要使用本地时区。否则，当您的数据库部署在跨多个时区的多个数据中心的高可用性设计中时，您将会非常紧张。

## 在 API 中使用什么格式

移动应用和单页应用等前端客户端需要通过 API 与后端通信，这些 API 可能有`datetime`字段。像数据库一样，为了保持 API 的一致性，HTTP 响应的有效负载应该总是使用 UTC。然而，你的 API 应该遵循健壮性原则:*在你做的事情上要保守，在你从别人那里接受的东西上要开明。*因此，您的 API 应该解析 HTTP 请求体或 URL 参数中的任何时区，而不需要 UTC。一些 API 将时区信息的缺失默认为 UTC。

与大多数数据库不同，JSON 中没有本地的`datetime`数据类型，因此日期必须存储为 JSON `number`或 JSON `string`。这两种方法都可行，但是应该遵循标准，这意味着日期字符串应该被格式化为 T4 的 ISO 8601 格式之一。日期数字应该存储为 Unix 纪元时间[和指定秒或毫秒的 API 契约。](https://en.wikipedia.org/wiki/Unix_time)

这两种方法之间存在分歧。Twitter、DropBox、Segement.io APIs 使用 ISO 8601，Chargebee、Pusher 和 Stripe APIs 使用 Unix Epoch Time。

我们 Moesif 更喜欢 ISO 8601 ( `yyyy-MM-dd'T'HH:mm:ssZ`)，因为它是人类可读的，并且有特定的时区。如果历元是以秒或毫秒为单位，则没有歧义。ISO 8601 字符串是以一种支持体面的字符串排序和比较的方式编码的。

Epoch 也比 ISO 8601 有优势。如果您正在处理大容量传感器数据或物联网设备的 API，您可能需要 epoch，因为它支持较小的有效载荷，无需考虑压缩，并且更熟悉来自物联网/嵌入式背景的数据。

## 存储用户的时区并以当地时间显示

首先，决定是否需要存储用户的时区。

如果您的需求是在应用程序中只显示用户本地时间的日期时间，您甚至不需要存储用户的时区。浏览器 javascript 和移动 API 可以根据用户设置的时区和地区转换日期时间并打印出来。

但是，您可能会发现，您稍后将执行后端处理来启动与您的用户的通信，例如 Slack 警报或电子邮件。在这种情况下，您可能会在数据库中缓存用户的时区/地区信息。因此，您可以在发送提醒或电子邮件之前转换并漂亮地打印任何日期时间。

避免存储 UTC 偏移量的陷阱，因为偏移量经常会因夏令时等因素而改变。建议存储时区标识符，如`America/Los_Angeles`。有一个大多数日期时间库本身支持的时区的完整列表。

## 摘要

如果您有一个全球应用程序或 API，管理不同时区一开始看起来很有挑战性。这篇文章基本上概述了保持简单的策略，并且在向用户显示之前一直使用 UTC 时间。

**Moesif 是最先进的 API 分析平台，支持 REST、GraphQL、Web3 Json-RPC 等。成千上万的平台公司利用 Moesif 进行调试、监控和发现见解。**

[了解更多](https://www.moesif.com?utm_source=blog)