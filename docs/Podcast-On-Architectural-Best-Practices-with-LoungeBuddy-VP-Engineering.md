# LoungeBuddy 工程副总裁关于架构最佳实践的播客

> 原文：<https://www.moesif.com/blog/podcasts/api-product-management/Podcast-On-Architectural-Best-Practices-with-LoungeBuddy-VP-Engineering/>

Ep。7: Jessica Lam，LoungeBuddy/AmEx 前工程副总裁

### Moesif 的播客网络:为 API 产品经理和其他 API 专业人士提供可操作的见解。

加入 Moesif 的是 [Jesscia Lam](https://www.linkedin.com/in/jessicalam1/) ，目前是初创公司的技术顾问和天使投资人，也是被美国运通收购的 [LoungeBuddy](https://www.loungebuddy.com/) 的原首席架构师和工程副总裁。在 LoungeBuddy，她设计了他们的 API，其中许多一直沿用至今。

作为多家公司的首席技术官、架构师和工程主管，Jessica 分享了她在以下方面的经验:如何构建更具弹性的产品、为什么错误处理如此重要、如何看待内部 API 和外部 API，等等。

德瑞克·吉林，Moesif 的首席执行官是今天的主持人。

[https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/972780301&color=%23ff4f00&auto_play=false&hide_related=true&show_comments=true&show_user=true&show_reposts=false&show_teaser=true](https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/972780301&color=%23ff4f00&auto_play=false&hide_related=true&show_comments=true&show_user=true&show_reposts=false&show_teaser=true)

[Moesif](https://soundcloud.com/moesifhq "Moesif") · [Architectural Best Practices with LoungeBuddy](https://soundcloud.com/moesifhq/architectural-best-practices-with-loungebuddy-vp-engineering-jessica-lam "Architectural Best Practices with LoungeBuddy")

在 SoundCloud 上听这一集，在苹果或谷歌上下载，或者在 [YouTube](https://youtu.be/ywBSh1lzuwY) 上观看。

[![Listen on Apple Podcasts](img/0f035c1005fd9c71c8f40242b9519f3d.png)](https://podcasts.apple.com/us/podcast/7-architectural-best-practices-with-loungebuddy-amex/id1545437670?i=1000506571663) [![Listen on Google Podcasts](img/5dde28e33453b3096c5f996f6d62b5af.png)](https://podcasts.google.com/feed/aHR0cHM6Ly9mZWVkcy5zb3VuZGNsb3VkLmNvbS91c2Vycy9zb3VuZGNsb3VkOnVzZXJzOjg4ODY5ODI0NS9zb3VuZHMucnNz/episode/dGFnOnNvdW5kY2xvdWQsMjAxMDp0cmFja3MvOTcyNzgwMzAx?sa=X&ved=0CAcQuIEEahcKEwiIz7a_wcnuAhUAAAAAHQAAAAAQAQ)

目录

*   [0:30API 是简洁的值单位](#apis-are-concise-units-of-value)
*   [4:44 不要区别对待内部 APIs】](#do-not-treat-internal-apis-differently)
*   [6:55 用流量控制器简化新的 APIs】](#simplify-new-apis-with-a-traffic-controller)
*   [9:55 内置好错误处理](#build-in-good-error-handling)
*   [13:40 遵循 80-20 法则进行测试](#follow-the-80-20-rule-for-testing)
*   [15:53 尽可能减少技术债务，快速行动](#minimize-technical-debt-and-move-quickly)

**德里奇·吉林(Moesif):** 欢迎来到 Moesif 的 APIs over IPAs 播客网络的另一集。今天我将和你们的主持人以及 API 可观测性平台的 CEO 和 Moesif 一起讨论。加入我的是 Jessica Lam，她曾是 LoungeBuddy 的首席架构师和工程副总裁。他们被美国运通收购，她在那里设计了许多 API，这些 API 一直沿用至今。我希望听到更多关于这方面的信息，比如您是如何设计的，以及在规划过程中做出了哪些设计决策。

## API 是简明的价值单位

把你的 API 想象成简洁的价值单元，提供其他人可以重用并从中获取价值的特性或任务。

杰西卡·林(LoungeBuddy): 酷。所以这些 API 的发展在我看来就像是公司和产品的自然发展。最初，该产品只是一个移动应用程序，背后有常见的应用程序支持，除此之外没有任何 API。在那个移动应用起飞后，我在种子期前就加入了。因此，作为第一个被聘用的工程师，也是首席建筑师，我们考虑的第一个主要项目是*如何为休息室*采购。关于 LoungeBuddy，它最初是一个休息室搜索器，后来成为一个休息室管理平台。

在我们决定添加购买的时候，有一种想法是，购买休息室不应该在概念上仅限于应用程序。因此，当时的观点是，这是一个*简明的价值单位*，任何人都可以从中获取价值。因此，在未来，如果我们正在构建一个 web 应用程序，或者如果我们正在为外部合作伙伴构建一个网站，这种简洁的价值单位可以被重用。因此，回到我的计算器编程时代，在那里我抵消重复的任务，并真正思考什么是其他人可以从中获得价值的重复使用的东西，这就是 API 想法的来源。因此，我们不要将此作为应用程序后端的一部分，我们启动 API 服务会更有意义。

因此，我们思考如何集中管理所有这些东西。将它分解成购买的基本步骤，首先我们需要检查可用性，看看是否有特定休息室的库存。所以，只要看看这句话，你就会意识到有某些变量，比如哪个休息室，所以你知道那是你传递给 API 的一个参数。看完供货情况后，你会转向下一件你感兴趣的事情:它的定价是多少？然后，在那之后，弄清楚如何购买。所以最初，从概念上考虑，什么是必要的步骤，然后把它放在那里，并对它进行迭代。

我的核心工程哲学之一是，让事情变得容易比试图预测未来更好。因此，在构建了采购 API 之后，我们首先开始使用我们的移动应用程序对其进行测试。因此，在移动应用中，我们使用购买流程来帮助我们进行沟通，比如:API 是否有意义，它是否足够简洁，或者它是否过于复杂。解决了这个问题之后，我们开始开发使用相同 API 的网站。

德里奇:真的很棒，尤其是考虑到简洁的价值单位。每当你看到一个 API，了解你如何为你的客户提供更多的价值，它是否是可重复的。你是如何衡量的？有没有一种方法可以理解每种 API 给企业带来的每种价值？

**Jessica:** 我想说这是这个平台所缺乏的东西，我真的希望很多很多年前我们开始的时候你们还在。我们真的没有办法去衡量它。我们专注于错误处理，并确保它是健壮的，人们不会遇到错误。关于 API 调用的频率，我们有一些非常初步的表层指标，但不一定比这更多。显然，我们会知道有多少人通过 API 进行了购买。但是除了这些表面指标，我们真的没有什么其他的了。

## 不要区别对待内部 API

对待每一个客户，就像对待一个外部客户一样，这样，如果你真的开发了一个内部 API，它就能开箱即用了。

德里奇:我想我们应该早几年开始。说到你的 API，有些被你的移动应用使用，有些被你的网站使用，你实际上是如何组织你的内部 API 和面向外部的 API 的？它们是相同的还是不同的？

杰西卡:这是一个很好的问题，我的原则是，仅仅因为你是内部员工，并不意味着你会得到特殊待遇。使用这一原则开发 API 的一个非常有用的方法是，当我们向外部合作伙伴开放时，它就真的工作了。由于我们的开发方式，我们假设每个使用 API 的内部应用程序实际上都是一个“外部合作伙伴”，我们没有让内部 API 有一些特殊的后端东西来优化一些小东西，以便做他们想做的任何事情。而在前端和 app 后端的谈判中总是这样。对于任何与不同开发人员合作过的人来说，人们会说“哦，如果 API 只是返回所有这些，那么前端会容易得多”或类似的话。因此，抵制使用这些变通方法的冲动将会使 API 变得非常干净，并且在整个系统中关注点和责任的分离也非常干净。所以我认为我对内部开发 API 的建议是把每一个客户端都当作外部客户端来对待。

这是一个非常好的观点，特别是当我们去大公司的时候，那里有很多不同的团队访问 API，每个团队实际上都是客户。这也有助于提高安全性，确保您在外部应用的安全措施也适用于其他团队，这样您就不会遇到网络某个区域可能存在漏洞的情况。

## 用流量控制器简化新的 API

当支持新的 API 功能时，你不希望不得不重构你的应用。使用类似网关的服务(流量控制器)来访问您的 API，这样就可以通过控制器简单地支持迁移。

**Derric:** 再多讲一点这些 API，你是预先设计了这些 API，还是更像是从服务开始，然后围绕一个 API 来组织它？如何看待 API 第一？

杰西卡:这真是个好问题。我实际上用了两种不同的方法。对于采购 API 来说，从一开始就很明显，它将跨平台、跨我们所有不同的服务以及外部重用。但是还有其他的事情悄悄向我们袭来。例如，应用程序中有一个核心实用程序，它根据访问规则和访问项目查看休息室。一个访问项目的例子是你的信用卡，然后访问规则是这样的:如果你有这张信用卡，你入境到一个特定的机场，那么你可以访问这个特定的休息室，否则，如果你出境，那么你没有访问权。这些最初都在 iOS 应用程序中。因此，我们后来在与美国运通进行整合时意识到，需要能够访问该功能。在这一点上，弄清楚如何有效地将其抽象出来是一个有趣的过程。

有些人会说“好吧，让我们停止一切，完全重构那个应用程序，取出所有那些服务，把它放到一个不同的服务中”。在我看来，这实际上是一个非常高风险的努力，它不一定会给你带来你认为的那么多好处。我通常进行这种类型的迁移或改变系统内的模式的方法之一，是让它不使用真正的 API 网关，而是使用一种称为流量控制的服务。本质上，我们的期望是，如果您正在访问任何 API，您将使用流量控制服务。在流量控制服务的背后，有时实现了 API，但其他时候它实际上是重新路由到另一个服务的后端，该服务可能有您正在寻找的内容。因此，为了方便迁移，如果您想将代码从应用后端移动到实际的服务中，您可以选择使用流量控制来实现。

通过设置期望，如果你正在访问 API，使用流量控制。你不关心交通管制如何获得这些信息，只要合同是与交通管制签订的。所以我认为这也是保持速度的一个很好的方法，因为对于一个初创公司来说，速度是我们的突破口。我觉得这种操作方式真的很有帮助——不用预测未来。我们不知道我们将在外部使用这些，但有一种方法可以做到这一点，以一种风险非常低的方式。

## 内置良好的错误处理

当美国运通的 iPad 应用程序推出时，美国运通的集成合作伙伴没有错误处理功能，因此当出现多个 500 错误时，由 LoungeBuddy 来识别并让合作伙伴了解他们的问题。

德里奇:这是一个非常好的观点，尽快迭代的能力，特别是对于早期创业公司。但是你也提出了一个关于移民的有趣观点。你采取了什么程序来确保你没有破坏与美国运通或其他客户的整合？有合适的流程吗？

**杰西卡:**所以*启动和流程*这有点矛盾。我们与美国运通有几个整合点。一个是他们的应用程序使用了我们的购买 API。因此，现在如果你登录美国运通应用程序，然后进入休息室，最终生成的二维码来自我们的购买流程。另一次整合实际上是在 iPad 被引入美国运通贵宾室的时候。有与流程流的幕后集成，也有与外部合作伙伴的集成。因此，它的工作方式是，当有人刷卡时，卡号实际上被发送到他们的服务。因此，我们在获得认证和部署所有安全措施方面没有风险。之后，外部合作伙伴返回了一个访问项，然后我们在服务中做了一些事情来解决这个问题。

我们进行了大量的错误处理。最初与第三方的集成实际上有很多 500 错误。有趣的是，他们没有错误处理，所以他们实际上不知道发生了什么错误。但是因为我们有错误处理，我们就像“我们实际上从你那里得到了 500”这是错误信息。所以对于最初的发布，我不确定我应该谈论这个，但它有点像“所以在应用程序的前端，他们会看到 500 个错误”，但因为他们的服务没有错误处理，这取决于我们。我们和他们之间有很多的争吵。这就像当这种情况发生时，我们从你的服务中得到一个错误，即使用户在我们的应用程序上看到一个错误。这就是错误处理和非常好的错误处理的重要性。任何时候有可能出现某种错误，一定要记录下来。

**德里奇:**肯定。准备好错误处理和监控，这样您就可以放心发货了。没有它，你几乎是盲目飞行。您实际上是如何设置的，遇到了哪些挑战。

**杰西卡:**对。我想知道自从我大约一两年前离开以来，这种情况发生了多大的变化。但我们当时的方法是，我们使用 Heroku 后端，他们有一些现成的工具，如果您有超过一定百分比的错误，那么您可以设置一个警报来跟踪它。所以我们已经把这些都准备好了，还有一件事叫你，传呼机责任。我们用 PagerDuty 设置了警报，以便在不同服务上出现一定百分比的错误时，特别是较差的面向外部的服务，有人会接到呼叫。所以，准备好所有的错误处理，然后确保你不会在凌晨 3 点接到电话。

## 遵循 80-20 法则进行测试

不要以 100%的代码覆盖率为目标，而是测试你对外公开的特定 API 调用，比如 get 和 POSTs，运行火炮进行负载测试，然后得到一些东西，让它随着时间的推移变得更加健壮。

不，毫无疑问，我们看到很多客户在使用 PagerDuty，而且到目前为止服务还不错。Moesif 本身与 PagerDuty 有一个集成。当谈到测试时，你们有什么最佳实践或流程吗？它们是什么样的？测试 API 的挑战是什么？

杰西卡:是的，这是一个非常好的问题。当谈到启动和优化时，我们试图遵循 80/20 法则。显然有一些理论上的最佳实践，比如“哦，我们想要 100%的代码覆盖率”，或者“我们想要确保所有东西都经过测试”。我觉得在这一点上我有点与众不同。我想我的原则是测试最重要的东西，然后，如果随着时间的推移出现了额外的错误，那么你就这样添加测试。所以，做最基本的事情，然后看看你有什么样的空气，然后在此基础上建设——这是一种反脆弱的发展方式。

因此，我们做的一些事情显然是对实际的特定 API 调用本身进行真正强大的测试，比如 get 和 POSTs 以及所有对外公开的内容。在完成这些之后，有时，根据某个特定服务被调用的频率，我们还会在部署之前使用火炮进行负载测试，作为健全性测试，以确保不会因为高负载之类的原因而随机播放。这些测试在首次发射后分阶段进行。所以这又回到了我之前所说的，先获得一些东西，然后看看你会得到什么样的错误，然后随着时间的推移使它变得更加强大，而不是立即尝试过度设计。因此，当我们开始看到负载问题时，我们开始进行负载测试，看看每秒钟我们收到多少请求。我们在两倍的数量上运行负载测试，只是为了确保我们有足够的填充。

## 最大限度地减少技术债务，快速行动

永远要把露营地收拾得比你发现它的时候还要干净:当你修复一个 bug 或创建一个新功能时，你将会接触到现有的代码，当你接触到它时，如果有些东西是低效的，要有意愿去思考它并重新调整代码库。

毫无疑问，确保你不会过度设计对创业公司来说总是很重要的。在工程领导中，很多时候你要平衡客户需求和工程需求，你有技术债务。有哪些方法可以让你快速迭代并平衡客户需求，而不会让你的工程团队负担过重？

杰西卡:这真是个好问题。从我担任顾问或过去合作过的所有不同的初创企业来看，这总是一个问题。就像，事情总是进展得不够快，而且总是有技术债务。减轻这种重构风险的方法是，实际上总是让露营地比你发现它的时候更干净。例如，不要花一两个 sprint 去重构某个东西，因为你知道它开始有技术债务，理想的方式是在修复 bug 的过程中，或者在创建新功能的过程中，你将接触现有的代码。当你接触它的时候，如果有什么是低效的，要有意愿去思考它并重新调整代码库。

技术债务积累的主要原因是，当你第一次开发系统时，有一些关于关系的业务假设，但是随着时间的推移，可能因为不同的特性，这些关系可能会改变。因此，即使您可能注意到了设计级别或功能级别的更改，但缺少的部分是，有时您没有在代码级别进行更改。再一次，这又回到以整体的方式思考系统——这不是说你有设计，然后你有前端，后端和系统，这实际上是一回事。就像我说的，应该有一个贯穿其中的一致的概念线索，并将其设计成这种关系的可视化表示。因此，深刻理解这种关系，并确保这在代码中得到反映，在我看来，是我们能够尽可能减少技术债务的最佳方式，这是确保您能够快速前进的方式。如果这些概念被恰当地表示，那么以正确的方式重用它们是非常容易的。所以有这样一个理想，当你甚至没有为一个特定的方法设计，去采用一个特定的被使用的方式，它应该只是工作，它有点像一个框架。这实际上是我非常喜欢苹果框架的原因之一——如果你以正确的方式使用它，它通常会起作用。然而很多时候，我认为开发人员并没有真正考虑特定方法或 API 的意图，只是试图按照他们想要的方式去做。所以我认为重要的是花时间去理解，然后在开发过程中重构，而不是在真空中重构。

非常棒的见解，尤其是关于技术债务和如何思考开发的见解。杰西卡，很高兴你能来我们的播客，希望我们能很快在洛杉矶见到你。

杰西卡:是的，当然。